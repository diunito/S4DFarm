<template>
  <div class="exploit-alerts">
    <!-- Dialog per mostrare gli alert -->
    <q-dialog v-model="showAlert" persistent>
      <q-card class="alert-card" style="min-width: 400px">
        <q-card-section class="row items-center q-pb-none">
          <div class="text-h6 text-negative">
            <q-icon name="warning" class="q-mr-sm" />
            Exploit Alert!
          </div>
          <q-space />
          <q-btn icon="close" flat round dense v-close-popup />
        </q-card-section>

        <q-card-section>
          <div class="text-body1 q-mb-md">
            <strong>{{ alertData.total_alerts }}</strong> team(s) stopped being exploited between 
            tick {{ alertData.previous_tick }} and tick {{ alertData.current_tick }}:
          </div>
          
          <q-list bordered separator>
            <q-item 
              v-for="alert in alertData.alerts" 
              :key="`${alert.team}-${alert.service}`"
              class="alert-item"
            >
              <q-item-section avatar>
                <q-avatar color="negative" text-color="white" icon="bug_report" />
              </q-item-section>
              
              <q-item-section>
                <q-item-label class="text-weight-bold">{{ alert.team }}</q-item-label>
                <q-item-label caption>Service: {{ alert.service }}</q-item-label>
              </q-item-section>
              
              <q-item-section side>
                <div class="text-caption">
                  {{ alert.previous_flags }} â†’ {{ alert.current_flags }}
                </div>
              </q-item-section>
            </q-item>
          </q-list>
        </q-card-section>

        <q-card-actions align="right">
          <q-btn 
            flat 
            label="Dismiss" 
            color="primary" 
            v-close-popup 
          />
          <q-btn 
            flat 
            label="Don't show again this session" 
            color="grey" 
            @click="disableAlerts"
            v-close-popup 
          />
        </q-card-actions>
      </q-card>
    </q-dialog>

    <!-- Notification badge (opzionale, per mostrare il numero di alert attivi) -->
    <q-badge 
      v-if="hasActiveAlerts && !alertsDisabled" 
      color="negative" 
      floating
      class="alert-badge"
      @click="showLastAlert"
    >
      {{ lastAlertData?.total_alerts || 0 }}
      <q-tooltip>Click to view exploit alerts</q-tooltip>
    </q-badge>
  </div>
</template>

<script>
import { ref, watch, onMounted, onUnmounted } from 'vue'
import { useExploitNotifications } from '@/composables/useExploitNotifications'

export default {
  name: 'ExploitAlerts',
  props: {
    currentTick: {
      type: Number,
      required: true
    },
    autoCheck: {
      type: Boolean,
      default: true
    }
  },
  emits: ['alert-triggered'],
  setup(props, { emit }) {
    const showAlert = ref(false)
    const alertData = ref({})
    const lastAlertData = ref(null)
    const alertsDisabled = ref(false)
    const hasActiveAlerts = ref(false)
    const lastCheckedTick = ref(null)

    const { addNotification, notificationSettings } = useExploitNotifications()

    const checkForAlerts = async (currentTick, previousTick = null) => {
      if (alertsDisabled.value || !currentTick || currentTick <= 1) {
        return
      }

      // Evita controlli duplicati
      if (lastCheckedTick.value === currentTick) {
        return
      }

      try {
        const { api } = await import('@/services/api')
        const params = { current_tick: currentTick }
        if (previousTick) {
          params.previous_tick = previousTick
        }

        const response = await api.get('/team_stats_compare', { params })
        const data = response.data

        lastCheckedTick.value = currentTick

        if (data.alerts && data.alerts.length > 0) {
          alertData.value = data
          lastAlertData.value = data
          hasActiveAlerts.value = true
          
          // Aggiungi notifica al sistema
          addNotification(data)
          
          // Mostra popup solo se abilitato nelle impostazioni
          if (notificationSettings.value.showPopup) {
            showAlert.value = true
          }
          
          // Emetti evento per notificare il componente parent
          emit('alert-triggered', data)
          
          // Log per debugging
          console.log(`Exploit alerts detected for tick ${currentTick}:`, data.alerts)
        } else {
          hasActiveAlerts.value = false
        }
      } catch (error) {
        console.error('Error checking for exploit alerts:', error)
      }
    }

    const showLastAlert = () => {
      if (lastAlertData.value && lastAlertData.value.alerts.length > 0) {
        alertData.value = lastAlertData.value
        showAlert.value = true
      }
    }

    const disableAlerts = () => {
      alertsDisabled.value = true
      hasActiveAlerts.value = false
    }

    const enableAlerts = () => {
      alertsDisabled.value = false
      lastCheckedTick.value = null
    }

    // Event listener per mostrare gli alert da altre parti dell'app
    const handleShowAlert = (event) => {
      if (event.detail) {
        alertData.value = event.detail
        showAlert.value = true
      }
    }

    // Watch per cambiamenti nel tick corrente
    watch(() => props.currentTick, (newTick, oldTick) => {
      if (props.autoCheck && newTick && oldTick && newTick > oldTick) {
        checkForAlerts(newTick, oldTick)
      }
    })

    onMounted(() => {
      // Ascolta eventi globali per mostrare alert
      window.addEventListener('show-exploit-alert', handleShowAlert)
    })

    onUnmounted(() => {
      window.removeEventListener('show-exploit-alert', handleShowAlert)
    })

    // Metodo esposto per controllo manuale
    const manualCheck = (currentTick, previousTick = null) => {
      return checkForAlerts(currentTick, previousTick)
    }

    return {
      showAlert,
      alertData,
      lastAlertData,
      alertsDisabled,
      hasActiveAlerts,
      showLastAlert,
      disableAlerts,
      enableAlerts,
      manualCheck
    }
  }
}
</script>

<style scoped>
.exploit-alerts {
  position: relative;
}

.alert-card {
  max-width: 600px;
}

.alert-item {
  border-radius: 8px;
}

.alert-item:hover {
  background-color: #f5f5f5;
}

.alert-badge {
  position: fixed;
  top: 100px;
  right: 20px;
  z-index: 1000;
  cursor: pointer;
  animation: pulse-badge 2s infinite;
}

@keyframes pulse-badge {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
  100% {
    transform: scale(1);
  }
}

.text-negative {
  color: #c10015;
}
</style>
